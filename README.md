# Нейропродажник - Telegram Bot

## Обзор

"Нейропродажник" - это Telegram-бот, созданный для автоматизации процесса подбора тарифных планов для клиентов. Бот проводит онбординг через серию вопросов, анализирует ответы с помощью нейросети и рекомендует персональный тариф на основе предоставленной информации. 

Основная цель бота - улучшение пользовательского опыта и увеличение конверсии за счет персонализированного подхода к каждому клиенту.

### Ключевые функции:

- **Онбординг**: проведение пользователя через серию вопросов для сбора данных
- **Нейроаналитика**: анализ ответов пользователя с использованием OpenAI API
- **Рекомендации тарифов**: предложение оптимального тарифа с объяснением выбора
- **Триал-период**: управление 14-дневным пробным периодом
- **Уведомления**: отправка напоминаний о скором окончании триала
- **Админ-панель**: предоставление статистики и управление ботом

## Архитектура

Проект реализован с использованием модульной архитектуры, что обеспечивает гибкость, масштабируемость и поддерживаемость кода. Бот построен на асинхронном фреймворке aiogram 3.19.0 с использованием SQLite для хранения данных.

### Структура проекта:

```
/
├── bot.py               # Главный файл для запуска бота
├── config.py            # Конфигурация и константы
├── README.md            # Документация
├── requirements.txt     # Зависимости
├── .env                 # Переменные окружения
├── database/            # Модули работы с БД
│   ├── __init__.py
│   ├── db.py            # Функции для работы с БД
│   └── models.py        # Инициализация таблиц и данных
├── handlers/            # Обработчики сообщений
│   ├── __init__.py
│   ├── onboarding.py    # Онбординг и выбор тарифа
│   ├── trial.py         # Управление триал-периодом
│   └── admin.py         # Админские команды
├── keyboards/           # Клавиатуры
│   ├── __init__.py
│   ├── reply.py         # Обычные клавиатуры
│   └── inline.py        # Инлайн-клавиатуры
├── middlewares/         # Middleware
│   ├── __init__.py
│   └── trial_check.py   # Проверка триала
├── services/            # Внешние сервисы
│   ├── __init__.py
│   └── openai_api.py    # Интеграция с OpenAI
└── utils/               # Утилиты
    ├── __init__.py
    └── states.py        # FSM-состояния
```

### Технический стек:

- **Язык программирования**: Python 3.10+
- **Библиотека для Telegram**: aiogram 3.19.0
- **База данных**: SQLite
- **Хранение состояний**: FSM (Finite State Machine)
- **AI-интеграция**: OpenAI API (модель gpt-4.1-nano)
- **Асинхронность**: asyncio, aiosqlite

## Настройка и запуск

### Предварительные требования:

- Python 3.10 или выше
- Токен Telegram бота (получается у @BotFather)
- Ключ API OpenAI

### Настройка переменных окружения:

Создайте файл `.env` в корневой директории проекта со следующими переменными:

```
# Telegram Bot
TELEGRAM_BOT_TOKEN=ваш_токен_бота_здесь

# OpenAI
OPENAI_API_KEY=ваш_ключ_api_openai_здесь
OPENAI_MODEL=gpt-4.1-nano

# Admin IDs (optional)
ADMIN_IDS=123456789,987654321
```

### Установка зависимостей:

```bash
pip install -r requirements.txt
```

### Запуск бота:

```bash
python bot.py
```

## Модули и компоненты

### Ядро и конфигурация

#### `bot.py`

Основной файл проекта, отвечающий за инициализацию и запуск бота. Содержит настройку логгирования, инициализацию компонентов и регистрацию обработчиков.

Основные функции:
- Настройка логирования
- Инициализация бота и диспетчера
- Регистрация middleware и роутеров
- Инициализация базы данных
- Запуск фоновой задачи для проверки триал-периода
- Запуск поллинга

#### `config.py`

Конфигурационный файл, содержащий константы и настройки бота. Включает:
- Пути к файлам
- Токены и ключи API
- Настройки триал-периода
- Тексты сообщений
- Вопросы онбординга
- Шаблоны для запросов к OpenAI

### База данных

База данных SQLite используется для хранения информации о пользователях, их ответах на вопросы онбординга, тарифах и других данных.

#### `database/db.py`

Модуль с функциями для работы с базой данных. Содержит:
- SQL-запросы для создания таблиц
- Функции для управления пользователями
- Функции для работы с ответами онбординга
- Функции для управления тарифами
- Функции для получения статистики

#### `database/models.py`

Модуль для инициализации моделей базы данных и загрузки начальных данных:
- Предустановленные тарифы
- Загрузка вопросов для онбординга
- Инициализация таблиц

### Структура базы данных:

#### Таблицы:

1. **users** - информация о пользователях
   - `user_id` - ID пользователя в Telegram (первичный ключ)
   - `chat_id` - ID чата
   - `username` - имя пользователя
   - `first_name` - имя
   - `last_name` - фамилия
   - `registration_date` - дата регистрации
   - `trial_end_date` - дата окончания триала
   - `is_active` - активен ли пользователь
   - `tariff_id` - выбранный тариф

2. **onboarding_questions** - вопросы для онбординга
   - `id` - ID вопроса
   - `question_text` - текст вопроса
   - `question_type` - тип вопроса (text/options)

3. **onboarding_answers** - ответы пользователей на вопросы
   - `id` - ID ответа
   - `user_id` - ID пользователя
   - `question_id` - ID вопроса
   - `answer` - текст ответа
   - `answer_date` - дата ответа

4. **tariffs** - тарифные планы
   - `id` - ID тарифа
   - `name` - название тарифа
   - `description` - описание тарифа
   - `price` - стоимость

### Обработчики сообщений

#### `handlers/onboarding.py`

Обработчики для процесса онбординга и выбора тарифа:
- Запуск онбординга при старте бота
- Обработка ответов на вопросы
- Сохранение ответов в базу данных
- Отправка вопросов и взаимодействие с FSM
- Анализ ответов через OpenAI
- Отображение рекомендаций по тарифам
- Обработка выбора тарифа

#### `handlers/trial.py`

Обработчики для управления триал-периодом:
- Обработка кнопок для перехода на платную версию
- Отправка уведомлений о скором окончании триала
- Обработка завершения триал-периода
- Периодическая проверка статуса триалов

#### `handlers/admin.py`

Обработчики для админ-панели:
- Проверка прав администратора
- Отображение статистики (активные пользователи, конверсия, популярные тарифы)
- Рассылка сообщений пользователям

### Middleware

#### `middlewares/trial_check.py`

Middleware для проверки триал-периода:
- Проверка статуса активности пользователя
- Проверка даты окончания триала
- Ограничение функционала после окончания триала
- Добавление флага `trial_ended` в данные события

### Клавиатуры

#### `keyboards/reply.py`

Функции для создания обычных (reply) клавиатур:
- Стартовая клавиатура с кнопкой "Начать тест"
- Клавиатура с вариантами ответов для вопросов онбординга

#### `keyboards/inline.py`

Функции для создания инлайн-клавиатур:
- Клавиатура для выбора тарифа
- Клавиатура для уведомления о скором окончании триала
- Клавиатура для уведомления об окончании триала
- Клавиатура для просмотра подробностей о тарифе

### Интеграция с OpenAI

#### `services/openai_api.py`

Модуль для взаимодействия с OpenAI API:
- Инициализация клиента OpenAI
- Анализ ответов пользователя
- Формирование запросов к API
- Обработка структурированных ответов от нейросети

### Состояния FSM

#### `utils/states.py`

Определение состояний конечного автомата (FSM):
- `OnboardingStates` - состояния для процесса онбординга
- `TrialStates` - состояния для управления триал-периодом

## Пользовательские сценарии

### Сценарий 1: Онбординг и выбор тарифа

1. Пользователь запускает бота командой `/start`
2. Бот приветствует пользователя и предлагает начать тест
3. Пользователь нажимает кнопку "Начать тест"
4. Бот последовательно задает вопросы:
   - В какой сфере работает бизнес? (текстовый ответ)
   - Ожидаемый объем использования? (выбор из вариантов)
   - Месячный бюджет? (выбор из вариантов)
   - Размер команды? (выбор из вариантов)
   - Используемые инструменты? (текстовый ответ)
5. Бот анализирует ответы через OpenAI API
6. Бот предлагает рекомендуемый тариф и объяснение выбора
7. Пользователь может:
   - Выбрать тариф
   - Посмотреть подробности о тарифе
   - Связаться с менеджером
8. При выборе тарифа активируется триал-период на 14 дней

### Сценарий 2: Управление триал-периодом

1. За 1 день до окончания триала бот отправляет уведомление
2. Пользователь может:
   - Перейти на платную версию
   - Получить напоминание позже
   - Связаться с менеджером
3. После окончания триала:
   - Бот отправляет уведомление
   - Функционал бота ограничивается
   - Пользователю предлагается перейти на платную версию

### Сценарий 3: Использование админ-панели

1. Администратор отправляет команду `/admin`
2. Бот проверяет, есть ли у пользователя права администратора
3. Бот отображает статистику:
   - Количество активных пользователей
   - Конверсия в оплату
   - Популярные тарифы
4. Администратор может отправить рассылку всем пользователям с помощью команды `/broadcast`

## Расширение и дальнейшая разработка

### Возможные улучшения:

1. **Интеграция с платежной системой**
   - Добавление автоматической оплаты тарифов
   - Генерация счетов и чеков

2. **Расширение админ-панели**
   - Добавление веб-интерфейса для управления
   - Расширенная аналитика и отчеты

3. **Улучшение персонализации**
   - Более глубокий анализ ответов пользователя
   - Динамическое формирование вопросов

4. **Интеграция с CRM**
   - Экспорт данных о пользователях
   - Синхронизация статусов

5. **Дополнительные уведомления**
   - Настраиваемые напоминания
   - Дополнительные события для отправки сообщений

### Технические улучшения:

1. **Миграция на более надежное хранилище**
   - Переход с SQLite на PostgreSQL или MongoDB
   - Добавление кэширования с использованием Redis

2. **Улучшение безопасности**
   - Шифрование данных пользователей
   - Ограничение количества запросов

3. **Тестирование**
   - Добавление unit-тестов
   - Интеграционные тесты для проверки всего flow

4. **Деплой и CI/CD**
   - Настройка автоматического деплоя
   - Интеграция с системой контроля версий

## Заключение

Бот "Нейропродажник" представляет собой современное решение для автоматизации процесса подбора тарифов с использованием искусственного интеллекта. Модульная архитектура и использование асинхронного подхода обеспечивают высокую производительность и возможность дальнейшего расширения функциональности. 