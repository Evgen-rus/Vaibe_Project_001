# Схема взаимодействия промптов в проекте "Нейропродажник"

## 1. Жизненный цикл взаимодействия с пользователем и активация промптов

```
                    ┌───────────────┐
                    │ Запрос /start │
                    └───────┬───────┘
                            ▼
┌──────────────────────────────────────────────┐
│ Функция: cmd_start                           │
│ Состояние: OnboardingStates.waiting_for_start│
│ Промпт: WELCOME_MESSAGE                      │
└─────────────────────┬────────────────────────┘
                      ▼
              ┌───────────────────┐
              │ "Начать тест"     │
              └─────────┬─────────┘
                        ▼
┌────────────────────────────────────────────┐
│ Функция: onboarding_start                  │
│ Состояние: OnboardingStates.business_sphere│
│ Промпт: Вопрос #1 из ONBOARDING_QUESTIONS  │
└─────────────────────┬──────────────────────┘
                      ▼
┌────────────────────────────────────────────┐
│ Функция: process_business_sphere           │
│ Состояние: OnboardingStates.usage_volume   │
│ Промпт: Вопрос #2 из ONBOARDING_QUESTIONS  │
└─────────────────────┬──────────────────────┘
                      ▼
┌────────────────────────────────────────────┐
│ Функция: process_usage_volume              │
│ Состояние: OnboardingStates.budget         │
│ Промпт: Вопрос #3 из ONBOARDING_QUESTIONS  │
└─────────────────────┬──────────────────────┘
                      ▼
┌────────────────────────────────────────────┐
│ Функция: process_budget                    │
│ Состояние: OnboardingStates.team_size      │
│ Промпт: Вопрос #4 из ONBOARDING_QUESTIONS  │
└─────────────────────┬──────────────────────┘
                      ▼
┌────────────────────────────────────────────┐
│ Функция: process_team_size                 │
│ Состояние: OnboardingStates.current_tools  │
│ Промпт: Вопрос #5 из ONBOARDING_QUESTIONS  │
└─────────────────────┬──────────────────────┘
                      ▼
┌────────────────────────────────────────────────────────────────┐
│ Функция: process_current_tools                                 │
│ Запрос к OpenAI через analyze_onboarding_answers               │
│ Промпт: OPENAI_TARIFF_PROMPT с ответами пользователя          │
│ Структурированный вывод через функцию recommend_tariff         │
└─────────────────────┬──────────────────────────────────────────┘
                      ▼
┌────────────────────────────────────────────────────────────────┐
│ Состояние: OnboardingStates.tariff_selection                   │
│ Промпт: Рекомендация тарифа с объяснением                      │
│ Клавиатура: get_tariff_selection_keyboard                      │
└─────────────────────┬──────────────────────────────────────────┘
                      ▼
                  ┌───────┐
                  │Выбор  │
                  │действия│
                  └───┬───┘
                      ▼
      ┌──────────────┬─────────────┬───────────────┐
      ▼              ▼             ▼               ▼
┌──────────┐   ┌──────────┐  ┌───────────┐  ┌────────────┐
│select_   │   │tariff_   │  │back_to_   │  │contact_    │
│tariff    │   │details   │  │tariffs    │  │manager     │
└────┬─────┘   └────┬─────┘  └─────┬─────┘  └─────┬──────┘
     ▼              ▼              ▼              ▼
┌──────────┐   ┌──────────┐   ┌───────────┐  ┌────────────┐
│Активация │   │Показ     │   │Возврат к  │  │Сообщение о │
│триала    │   │деталей   │   │списку     │  │связи с     │
│          │   │тарифа    │   │тарифов    │  │менеджером  │
└────┬─────┘   └────┬─────┘   └─────┬─────┘  └────────────┘
     │              │              │
     └──────────────┴──────────────┘
```

## 2. Подробное описание ключевых промптов

### 2.1. Приветственный промпт (`WELCOME_MESSAGE` в config.py)

**Активация**: Команда `/start`
**Функция**: `cmd_start` в handlers/onboarding.py
**Состояние**: `OnboardingStates.waiting_for_start`
**Текст**:
```
Привет! Я бот-нейропродажник, который поможет подобрать оптимальный тариф для вашего бизнеса.
Пройдите небольшой опрос, чтобы я мог сделать персональную рекомендацию.
```

### 2.2. Вопросы онбординга (`ONBOARDING_QUESTIONS` в config.py)

**Активация**: Последовательно после нажатия кнопки "Начать тест"
**Функции**: `onboarding_start`, `process_business_sphere` и т.д.
**Состояния**: Переходы между состояниями в `OnboardingStates`

```python
ONBOARDING_QUESTIONS = [
    {
        "id": 1,
        "text": "В какой сфере работает ваш бизнес?",
        "type": "text"
    },
    {
        "id": 2,
        "text": "Какой объем использования вы ожидаете?",
        "type": "options",
        "options": ["Низкий (до 100 запросов в день)", "Средний (100-500 запросов)", "Высокий (более 500 запросов)"]
    },
    {
        "id": 3,
        "text": "Какой у вас месячный бюджет на данный инструмент?",
        "type": "options",
        "options": ["До 2000 руб.", "2000-5000 руб.", "5000-10000 руб.", "Более 10000 руб."]
    },
    {
        "id": 4,
        "text": "Сколько человек в вашей команде будут использовать систему?",
        "type": "options",
        "options": ["1-3", "4-10", "11-50", "Более 50"]
    },
    {
        "id": 5,
        "text": "Какие инструменты вы используете сейчас?",
        "type": "text"
    }
]
```

### 2.3. Промпт для OpenAI (`OPENAI_TARIFF_PROMPT` в config.py)

**Активация**: После получения всех ответов на вопросы онбординга
**Функция**: `analyze_onboarding_answers` в services/openai_api.py
**Состояние**: После `OnboardingStates.current_tools`

**Шаблон промпта**:
```
Проанализируй ответы пользователя на вопросы и порекомендуй оптимальный тариф из трех вариантов:

Ответы пользователя:
{answers}

Предложи три тарифа с разными ценами и функциональностью, учитывая ответы пользователя.
Рекомендуй один из них как наиболее подходящий и объясни почему.
```

**Пример заполненного промпта**:
```
Проанализируй ответы пользователя на вопросы и порекомендуй оптимальный тариф из трех вариантов:

Ответы пользователя:
Вопрос: В какой сфере работает ваш бизнес?
Ответ: Интернет-магазин одежды

Вопрос: Какой объем использования вы ожидаете?
Ответ: Средний (100-500 запросов)

Вопрос: Какой у вас месячный бюджет на данный инструмент?
Ответ: 2000-5000 руб.

Вопрос: Сколько человек в вашей команде будут использовать систему?
Ответ: 4-10

Вопрос: Какие инструменты вы используете сейчас?
Ответ: Excel, GoogleSheets, 1С

Предложи три тарифа с разными ценами и функциональностью, учитывая ответы пользователя.
Рекомендуй один из них как наиболее подходящий и объясни почему.
```

## 3. Детали формирования запроса к OpenAI API

### 3.1. Структура запроса к OpenAI в `analyze_onboarding_answers`

```python
# Форматируем ответы для запроса к OpenAI
formatted_answers = "\n".join([f"Вопрос: {answer['question_text']}\nОтвет: {answer['answer']}" 
                          for answer in answers])

# Подготавливаем промпт
prompt = OPENAI_TARIFF_PROMPT.format(answers=formatted_answers)

# Создаем запрос к OpenAI API с structured outputs
response = await client.chat.completions.create(
    model=OPENAI_MODEL,
    messages=[
        {"role": "system", "content": "Ты аналитик по подбору тарифов для бизнеса."},
        {"role": "user", "content": prompt}
    ],
    tools=[{
        "type": "function",
        "function": {
            "name": "recommend_tariff",
            "description": "Рекомендует тарифы на основе ответов пользователя",
            "parameters": {
                "type": "object",
                "properties": {
                    "tariffs": {
                        "type": "array",
                        "items": {
                            "type": "object",
                            "properties": {
                                "name": {"type": "string"},
                                "description": {"type": "string"},
                                "price": {"type": "number"},
                                "features": {
                                    "type": "array",
                                    "items": {"type": "string"}
                                }
                            },
                            "required": ["name", "description", "price", "features"]
                        }
                    },
                    "recommendation": {"type": "string"},
                    "explanation": {"type": "string"}
                },
                "required": ["tariffs", "recommendation", "explanation"]
            }
        }
    }],
    tool_choice={"type": "function", "function": {"name": "recommend_tariff"}}
)
```

### 3.2. Обработка ответа от OpenAI

```python
# Извлекаем ответ
tool_call = response.choices[0].message.tool_calls[0]
tariff_data = json.loads(tool_call.function.arguments)
```

### 3.3. Структура ожидаемого ответа от OpenAI

```json
{
  "tariffs": [
    {
      "name": "Базовый",
      "description": "Тариф для небольших интернет-магазинов с базовым функционалом",
      "price": 2490,
      "features": [
        "Обработка до 300 запросов в день",
        "Базовая аналитика продаж",
        "Интеграция с 1С",
        "Email-поддержка"
      ]
    },
    {
      "name": "Стандарт",
      "description": "Оптимальный выбор для растущих интернет-магазинов",
      "price": 4990,
      "features": [
        "Обработка до 500 запросов в день",
        "Расширенная аналитика продаж",
        "Интеграция с 1С и CRM-системами",
        "Приоритетная поддержка",
        "API для разработчиков"
      ]
    },
    {
      "name": "Премиум",
      "description": "Полный набор функций для крупных интернет-магазинов",
      "price": 9990,
      "features": [
        "Неограниченное количество запросов",
        "Полная аналитика с прогнозированием",
        "Все доступные интеграции",
        "Персональный менеджер",
        "Круглосуточная поддержка",
        "Кастомизация под требования клиента"
      ]
    }
  ],
  "recommendation": "Стандарт",
  "explanation": "Для вашего интернет-магазина одежды с командой 4-10 человек и средним объемом запросов (100-500) тариф «Стандарт» будет оптимальным выбором. Он соответствует вашему бюджету 2000-5000 руб. и предоставляет все необходимые функции для эффективной работы, включая интеграцию с 1С, которую вы уже используете."
}
```

## 4. Формирование сообщения с рекомендацией

После получения ответа от OpenAI в функции `process_current_tools`:

```python
# Формируем сообщение с рекомендацией
if tariff_data:
    tariff_names = [tariff["name"] for tariff in tariff_data["tariffs"]]
    recommendation = tariff_data["recommendation"]
    explanation = tariff_data["explanation"]
    
    message_text = (
        f"Я рекомендую тариф «{recommendation}»!\n\n"
        f"{explanation}\n\n"
        "Выберите один из предложенных вариантов:"
    )
    
    # Клавиатура для выбора тарифа
    keyboard = get_tariff_selection_keyboard(tariff_names)
    
    # Отправляем сообщение с рекомендацией и клавиатурой
    await message.answer(text=message_text, reply_markup=keyboard)
    
    # Устанавливаем состояние выбора тарифа
    await state.set_state(OnboardingStates.tariff_selection)
```

## 5. Альтернативные сценарии и обработка ошибок

### 5.1. Ошибка при анализе ответов

Если функция `analyze_onboarding_answers` вернула None из-за ошибки:

```python
else:
    # Если произошла ошибка при анализе ответов
    await message.answer(
        "К сожалению, не удалось подобрать тариф на основе ваших ответов. "
        "Пожалуйста, свяжитесь с менеджером для получения персональной консультации."
    )
```

### 5.2. Сценарий управления триал-периодом

**Напоминания о триале**: Функция `send_trial_ending_notification` отправляет уведомления за день до окончания триала.

**Окончание триала**: Функция `handle_ended_trials` деактивирует пользователей с истекшим триал-периодом.

**Middleware**: `TrialMiddleware` проверяет статус триала для каждого входящего сообщения и помечает истекшие триалы флагом `trial_ended`.

## 6. Существующие тарифы (заготовки в базе данных)

Предустановленные тарифы из `database/models.py`:

```python
DEFAULT_TARIFFS = [
    {
        "name": "Базовый",
        "description": "Тариф для небольших компаний и индивидуальных предпринимателей. Включает основной функционал без дополнительных опций.",
        "price": 1990.0
    },
    {
        "name": "Стандарт",
        "description": "Оптимальный выбор для среднего бизнеса. Включает расширенный функционал и приоритетную поддержку.",
        "price": 4990.0
    },
    {
        "name": "Премиум",
        "description": "Полный набор функций для крупного бизнеса. Включает все возможности системы, персонального менеджера и круглосуточную поддержку.",
        "price": 9990.0
    }
]
```

Эти предустановленные тарифы нужны только для инициализации БД, фактические рекомендации формируются динамически с помощью OpenAI на основе ответов пользователя.
